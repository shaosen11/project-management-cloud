<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.lingnan.dao.ProjectUserDao">

    <resultMap type="com.edu.lingnan.entity.ProjectUser" id="ProjectUserMap">
        <result property="id" column="id" jdbcType="INTEGER"/>
        <result property="projectId" column="project_id" jdbcType="INTEGER"/>
        <result property="userId" column="user_id" jdbcType="INTEGER"/>
        <result property="dutyCode" column="duty_code" jdbcType="INTEGER"/>
        <result property="codeDevoteLine" column="code_devote_line" jdbcType="INTEGER"/>
        <result property="codeUpdate" column="code_update" jdbcType="INTEGER"/>
        <result property="deleteFlag" column="delete_flag" jdbcType="INTEGER"/>
        <result property="joinTime" column="join_time" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!--查找所有项目用户信息-->
    <resultMap id="pulist" type="com.edu.lingnan.entity.ProjectUser">
        <result column="id" property="id"></result>
        <result column="pid" property="projectId"></result>
        <result column="uid" property="userId"></result>
        <result column="codedevoteline" property="codeDevoteLine"></result>
        <result column="codeupdate" property="codeUpdate"></result>
        <result column="username" property="sysUser.username"></result>
        <result column="pname" property="project.name"></result>
    </resultMap>
    <select id="getProjectUserList" resultMap="pulist">
        select pu.id          as id,
               pu.project_id as pid,
               pu.user_id     as uid,
               pu.code_update as codeupdate,
               u.username     as username,
               p.name         as pname
        from project_management_project_cloud.project_user pu,
             project_management_user_cloud.sys_user u,
             project_management_project_cloud.project p
        where pu.delete_flag = 1
          and pu.project_id = p.id
          and pu.user_id = u.id
    </select>

    <!--查找所有被注销项目用户信息-->
    <resultMap id="delpulist" type="com.edu.lingnan.entity.ProjectUser">
        <result column="id" property="id"></result>
        <result column="pid" property="projectId"></result>
        <result column="uid" property="userId"></result>
        <result column="codedevoteline" property="codeDevoteLine"></result>
        <result column="codeupdate" property="codeUpdate"></result>
        <result column="username" property="sysUser.username"></result>
        <result column="pname" property="project.name"></result>
    </resultMap>
    <select id="getDelProjectUserList" resultMap="delpulist">
        select pu.id          as id,
               pu.project_id as pid,
               pu.user_id     as uid,
               pu.code_update as codeupdate,
               u.username     as username,
               p.name         as pname
        from project_management_project_cloud.project_user pu,
             project_management_user_cloud.sys_user u,
             project_management_project_cloud.project p
        where pu.delete_flag = 0
          and pu.project_id = p.id
          and pu.user_id = u.id
    </select>

    <!--删除一条记录-->
    <update id="delete">
        update project_management_project_cloud.project_user
        set delete_flag = 0
        where id = #{id}
    </update>

    <!--通过ProjectsId删除一条记录-->
    <update id="deleteProjectUserByProjectsId">
        update project_management_project_cloud.project_user
        set delete_flag = 0
        where project_id = #{id}
    </update>

    <!--还原一条记录-->
    <update id="reductionProjectUser">
        update project_management_project_cloud.project_user
        set delete_flag = 1
        where id = #{id}
    </update>


    <select id="getByUserIdAndProjectId" resultMap="ProjectsUserList">
        select *
        from project_management_project_cloud.project_user
        where delete_flag = 1
          and user_id = #{userId}
          and project_id = #{projectId}
    </select>

    <select id="getById" resultType="com.edu.lingnan.entity.ProjectUser">
        select *
        from project_management_project_cloud.project_user
        where delete_flag = 1
          and id = #{id}
    </select>

    <select id="getDelById" resultType="com.edu.lingnan.entity.ProjectUser">
        select *
        from project_management_project_cloud.project_user
        where delete_flag = 0
          and id = #{id}
    </select>

    <resultMap id="codeDevoteData" type="com.edu.lingnan.entity.Echarts">
        <result column="name" property="name"/>
        <result column="value" property="value"/>
    </resultMap>

    <select id="getCodeDevote" resultMap="codeDevoteData">
        SELECT c.username as name, code_devote_line as value
        from project_management_project_cloud.project_user a,
             project_management_user_cloud.sys_user c
        where a.user_id = c.id
          and a.project_id = #{project_id}
        group by a.user_id
        order by code_devote_line desc
    </select>

    <resultMap id="codeInsertData" type="com.edu.lingnan.entity.Echarts">
        <result column="name" property="name"/>
        <result column="value" property="value"/>
    </resultMap>

    <select id="getCodeInsert" resultType="Integer" resultMap="codeInsertData">
        SELECT c.username as name, code_update as value
        from project_management_project_cloud.project_user a,
             project_management_user_cloud.sys_user c
        where a.user_id = c.id
          and a.project_id = #{project_id}
        group by a.user_id
        order by code_update desc
    </select>

    <select id="getCountByProjectId" resultType="int">
        select count(*)
        from project_management_project_cloud.project_user
        where delete_flag = 1
          and project_id = #{projectId}
    </select>

    <!--查找所有项目功能点信息-->
    <resultMap id="ProjectsUserList" type="ProjectUser">
        <result column="id" property="id"></result>
        <result column="pid" property="projectId"></result>
        <result column="uid" property="userId"></result>
        <result column="duty_code" property="dutyCode"></result>
        <result column="code_devote_line" property="codeDevoteLine"></result>
        <result column="code_update" property="codeUpdate"></result>
        <result column="user_id" property="SysUser.id"></result>
        <result column="username" property="SysUser.username"></result>
        <result column="email" property="SysUser.email"></result>
        <result column="photo" property="SysUser.photo"></result>
        <collection property="projectUserDuty" column="{id=duty_code}"
                    select="com.edu.lingnan.dao.ProjectUserDutyDao.getById">
        </collection>
    </resultMap>

    <select id="getPageProjectUserByProjectId" resultMap="ProjectsUserList">
        select pu.id               as id
             , pu.project_id       as pid
             , pu.user_id          as uid
             , pu.duty_code        as duty_code
             , pu.code_devote_line as code_devote_line
             , pu.code_update      as code_update
             , u.id                as user_id
             , u.username          as username
             , u.email             as email
             , u.photo             as photo
        from project_management_project_cloud.project_user pu,
             project_management_user_cloud.sys_user u
        where delete_flag = 1
          and project_id = #{projectId}
          and pu.user_id = u.id
        order by code_devote_line desc
        limit #{offset},#{pageSize};
    </select>

    <select id="getAllProjectUserByProjectId" resultMap="ProjectsUserList">
        select *
        from project_management_project_cloud.project_user
        where delete_flag = 1
          and project_id = #{projectId}
        order by code_devote_line desc
    </select>

    <select id="getCountNoInProjectByProjectId" resultType="int">
        select count(*)
        from project_management_user_cloud.sys_user
        WHERE id not in
              (select user_id
               from project_management_project_cloud.project_user
               where delete_flag = 1
                 and projects_id = #{projectId});
    </select>

    <select id="getProjectUserNoInProjectByProjectId" resultType="com.edu.lingnan.entity.SysUser">
        select *
        from project_management_user_cloud.sys_user
        WHERE id not in
              (select user_id
               from project_management_project_cloud.project_user
               where delete_flag = 1
                 and projects_id = #{projectId})
        limit #{offset},#{pageSize}
    </select>

    <select id="getAllProjectByUserId" resultMap="ProjectsUserList">
        select *
        from project_management_project_cloud.project_user
        where delete_flag = 1
          and user_id = #{userId}
    </select>

    <select id="getCountByProjectIdAndDuty" resultType="int">
        select count(*)
        from project_management_project_cloud.project_user
        where delete_flag = 1
          and project_id = #{projectId}
          and duty_code = #{dutyCode}
    </select>


</mapper>